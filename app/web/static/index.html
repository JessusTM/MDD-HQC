<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HQC-MDD</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    /* Fondo general negro */
    body {
      background: #000;
      color: #fff;
    }

    /* Cuadros de trabajo blancos */
    .workspace {
      background: #fff;
      border: 2px solid #cfd2d4;
      border-radius: .6rem;
      min-height: 340px;
      position: relative;
      color: #222;
      overflow: hidden;
    }

    .workspace h3 {
      font-weight: 600;
      letter-spacing: .5px;
      margin: 0;
    }

    /* Botón expandir */
    .btn-expand {
      position: absolute;
      top: .6rem;
      right: .6rem;
      line-height: 1;
      border: 1px solid #adb5bd;
      color: #212529;
      background: rgba(255, 255, 255, .85);
    }

    /* Panel de métricas gris */
    .metrics-panel {
      background: #1f1f1f;
      border: 1px solid #2b2b2b;
      border-radius: .6rem;
      min-height: 160px;
      color: #e9ecef;
    }

    /* Selects oscuros */
    .controls .form-select {
      min-width: 210px;
      background: #0b0b0b;
      color: #fff;
      border: 1px solid #343a40;
    }

    .controls .form-select:focus {
      box-shadow: none;
      border-color: #0d6efd;
    }

    .controls .btn-primary,
    .controls .btn-danger {
      font-weight: 700;
    }

    /* Editor embebido pequeño */
    #istarEmbed {
      width: 100%;
      height: 100%;
      border: 0;
    }

    .istar-embed-wrap {
      position: absolute;
      inset: 0.75rem 0.75rem 0.75rem 0.75rem;
    }

    /* Modal: iframe grande */
    #istarModalIframe {
      width: 100%;
      height: 70vh;
      border: 0;
      background: #fff;
    }
  </style>
</head>

<body class="text-light">
  <main class="container py-5">

    <!-- Fila principal -->
    <div class="row g-4 mb-4">

      <!-- i* (draw.io) -->
      <div class="col-12 col-md-4">
        <div class="workspace">
          <button class="btn btn-sm btn-expand" type="button" title="Expandir" data-bs-toggle="modal"
            data-bs-target="#istarModal">⤢</button>
          <div class="istar-embed-wrap">
            <!-- Editor compacto (mismo scratchpad) -->
            <iframe id="istarEmbed" src="https://app.diagrams.net/?embed=1&ui=min&spin=1&proto=json&lang=es&draft=1"
              title="i* (draw.io)">
            </iframe>
          </div>
        </div>
      </div>

      <!-- UVL -->
      <div class="col-12 col-md-4">
        <div class="workspace d-flex align-items-center justify-content-center">
          <h3 class="m-0 text-center">UVL</h3>
        </div>
      </div>

      <!-- Código -->
      <div class="col-12 col-md-4">
        <div class="workspace d-flex align-items-center justify-content-center">
          <h3 class="m-0 text-center">Código</h3>
        </div>
      </div>
    </div>

    <!-- Métricas -->
    <section class="metrics-panel p-4 mb-4">
      <h4 class="text-center text-uppercase mb-3">Métricas</h4>
      <div class="text-secondary"><small>Ejecute una transformación para ver métricas…</small></div>
    </section>

    <!-- Controles -->
    <section class="controls d-flex flex-wrap align-items-center justify-content-center gap-3">
      <div class="d-flex align-items-center gap-2">
        <label for="fromStage" class="form-label m-0">Desde</label>
        <select id="fromStage" class="form-select form-select-lg">
          <option value="istar" selected>i*</option>
          <option value="uvl">UVL</option>
          <option value="codigo">Código</option>
        </select>
      </div>

      <span class="mx-1">hacia</span>

      <div class="d-flex align-items-center gap-2">
        <label for="toStage" class="form-label m-0 visually-hidden">Hacia</label>
        <select id="toStage" class="form-select form-select-lg">
          <option value="uvl" selected>UVL</option>
          <option value="istar">i*</option>
          <option value="codigo">Código</option>
        </select>
      </div>

      <!-- Azul y rojo -->
      <button class="btn btn-primary btn-lg">Configurar</button>
      <button id="btnTransformar" class="btn btn-danger btn-lg">Transformar</button>
    </section>
  </main>

  <!-- Modal con editor draw.io grande -->
  <div class="modal fade" id="istarModal" tabindex="-1" aria-labelledby="istarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="istarModalLabel">i* (draw.io) — Editor</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body p-0">
          <iframe id="istarModalIframe" src="https://app.diagrams.net/?embed=1&ui=min&spin=1&proto=json&lang=es&draft=1"
            title="i* (draw.io) — Modal">
          </iframe>
        </div>
        <div class="modal-footer border-secondary">
          <button id="guardarCerrar" type="button" class="btn btn-primary">Guardar y cerrar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar sin guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ========= Scratchpad único (XML) ========= */
    // XML mínimo de diagrams.net (puedes reemplazarlo por tu Scratchpad i*)
    let scratchpadXml =
      '<mxfile host="app.diagrams.net" modified="2025-01-01T00:00:00.000Z" agent="HQC-MDD" version="21.7.9">' +
      '<diagram id="istar" name="i*"><mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/>' +
      '<object id="actor-1" label="Actor" type="actor"><mxCell vertex="1" parent="1">' +
      '<mxGeometry x="60" y="60" width="80" height="40" as="geometry"/></mxCell></object>' +
      '</root></mxGraphModel></diagram></mxfile>';

    const EMBED_ORIGIN = 'https://app.diagrams.net';
    const smallFrame = document.getElementById('istarEmbed');
    const modalFrame = document.getElementById('istarModalIframe');

    // Carga el XML cuando el editor avisa 'init'
    window.addEventListener('message', (evt) => {
      if (evt.origin !== EMBED_ORIGIN) return;
      const msg = evt.data || {};
      // editor listo
      if (msg.event === 'init') {
        evt.source.postMessage({action: 'load', xml: scratchpadXml}, EMBED_ORIGIN);
        // configuración: autosave para que mande 'export' frecuentemente
        evt.source.postMessage({action: 'configure', config: {autosave: 1}}, EMBED_ORIGIN);
      }
      // export del editor => actualizamos el scratchpad y sincronizamos el otro iframe
      if (msg.event === 'export' && msg.format === 'xml' && typeof msg.data === 'string') {
        scratchpadXml = msg.data;
        // refresca el otro iframe con el XML más nuevo
        syncOther(evt.source);
      }
      // guardado manual (Ctrl+S) también trae xml
      if (msg.event === 'save' && typeof msg.xml === 'string') {
        scratchpadXml = msg.xml;
        syncOther(evt.source);
      }
    });

    function syncOther(sourceWin) {
      const targets = [smallFrame.contentWindow, modalFrame.contentWindow].filter(w => w && w !== sourceWin);
      targets.forEach(w => w.postMessage({action: 'load', xml: scratchpadXml}, EMBED_ORIGIN));
    }

    // Al abrir el modal, cargamos el XML vigente (por si el pequeño ya cambió)
    const istarModal = document.getElementById('istarModal');
    istarModal.addEventListener('shown.bs.modal', () => {
      modalFrame.contentWindow.postMessage({action: 'load', xml: scratchpadXml}, EMBED_ORIGIN);
    });

    // Guardar y cerrar: pedimos 'export xml' al editor del modal, luego cerramos
    document.getElementById('guardarCerrar').addEventListener('click', () => {
      // pedimos exportar a xml
      modalFrame.contentWindow.postMessage({action: 'export', format: 'xml'}, EMBED_ORIGIN);
      // cierra el modal después de un pequeño delay para asegurar recepción
      setTimeout(() => {
        const modal = bootstrap.Modal.getInstance(istarModal);
        modal && modal.hide();
      }, 200);
    });

    // Inicialización: si el iframe pequeño carga antes que el listener, igual recibirá 'init'
    // y disparará el flujo de carga del XML compartido.

    // Botón Transformar solo muestra el XML actual (placeholder del pipeline)
    document.getElementById('btnTransformar').addEventListener('click', () => {
      console.log('XML actual (scratchpad):', scratchpadXml);
      // Aquí conectarías: i* -> UVL -> Código
    });
  </script>
</body>

</html>
